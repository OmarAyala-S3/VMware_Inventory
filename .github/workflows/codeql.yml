name: "CodeQL Security Analysis"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    # Ejecuta todos los lunes a las 03:00 UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:
    # Permite ejecucion manual desde GitHub Actions

jobs:
  analyze:
    name: Analyze Python — ${{ matrix.scan-type }}
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # ── Escaneo de seguridad (vulnerabilidades criticas) ──────────────
          - language: python
            build-mode: none
            scan-type: "Security"
            queries: security-extended

          # ── Escaneo de calidad (bugs, code smells, mejoras) ───────────────
          - language: python
            build-mode: none
            scan-type: "Quality"
            queries: security-and-quality

    steps:
      # ── 1. Checkout ────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2   # Necesario para analisis de cambios en PRs

      # ── 2. Setup Python ────────────────────────────────────────────────────
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      # ── 3. Instalar dependencias ───────────────────────────────────────────
      # CodeQL analiza mejor el codigo cuando puede resolver los imports reales.
      # Esto permite detectar vulnerabilidades en dependencias externas tambien.
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r vmware_inventory/requirements.txt || true
          # Instalar dependencias de analisis extra
          pip install bandit safety

      # ── 4. Bandit — analisis de seguridad adicional ────────────────────────
      # Bandit detecta problemas que CodeQL no cubre (ej: assert en prod,
      # uso de subprocess, hardcoded secrets, etc.)
      - name: Run Bandit security scan
        if: matrix.scan-type == 'Security'
        run: |
          bandit -r vmware_inventory/ \
            --exclude vmware_inventory/venv,vmware_inventory/build,vmware_inventory/dist \
            --severity-level medium \
            --confidence-level medium \
            --format sarif \
            --output bandit-results.sarif || true

      # ── 5. Safety — vulnerabilidades en dependencias ──────────────────────
      # Compara requirements.txt contra la base de datos de CVEs de PyPI
      - name: Run Safety dependency check
        if: matrix.scan-type == 'Security'
        run: |
          safety check \
            --file vmware_inventory/requirements.txt \
            --output text || true

      # ── 6. Inicializar CodeQL ──────────────────────────────────────────────
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
          build-mode: ${{ matrix.build-mode }}
          queries: ${{ matrix.queries }}
          # Configuracion adicional para Python
          config: |
            paths:
              - vmware_inventory
            paths-ignore:
              - vmware_inventory/venv
              - vmware_inventory/build
              - vmware_inventory/dist
              - "**/__pycache__"
              - "**/*.pyc"
            query-filters:
              - exclude:
                  tags contain: experimental

      # ── 7. Ejecutar analisis CodeQL ────────────────────────────────────────
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python/scan:${{ matrix.scan-type }}"
          output: codeql-results
          upload: always

      # ── 8. Subir resultados Bandit a Security tab ──────────────────────────
      - name: Upload Bandit results to GitHub Security
        if: matrix.scan-type == 'Security' && hashFiles('bandit-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: bandit-results.sarif
          category: "bandit"

      # ── 9. Resumen en el log de Actions ───────────────────────────────────
      - name: Generate scan summary
        if: always()
        run: |
          echo "## CodeQL Scan Summary — ${{ matrix.scan-type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo        | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Tipo de scan | ${{ matrix.scan-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Queries      | ${{ matrix.queries }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rama         | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit       | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger      | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Resultados disponibles en la pestaña **Security → Code scanning alerts**" >> $GITHUB_STEP_SUMMARY

  # ── Job separado: reporte consolidado post-analisis ──────────────────────────
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: analyze
    if: always()

    permissions:
      contents: read
      security-events: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Final security summary
        run: |
          echo "## Resumen Final de Seguridad" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Herramientas ejecutadas" >> $GITHUB_STEP_SUMMARY
          echo "| Herramienta | Descripcion | Cobertura |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Security | Vulnerabilidades OWASP Top 10, CWE | Codigo fuente Python |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Quality  | Code smells, bugs, malas practicas | Codigo fuente Python |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit          | Seguridad especifica de Python | Codigo fuente Python |" >> $GITHUB_STEP_SUMMARY
          echo "| Safety          | CVEs en dependencias de PyPI | requirements.txt |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Alertas resueltas" >> $GITHUB_STEP_SUMMARY
          echo "- CWE-916: SHA-256 reemplazado por bcrypt (credentials.py, security.py)" >> $GITHUB_STEP_SUMMARY
          echo "- CWE-327: Algoritmo debil de hashing en datos sensibles — corregido" >> $GITHUB_STEP_SUMMARY
          echo "- CWE-328: Hash sin sal en contrasenas — corregido con bcrypt (sal automatica)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ver alertas activas en: **Security → Code scanning**" >> $GITHUB_STEP_SUMMARY
