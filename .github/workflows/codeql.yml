name: "CodeQL Security Analysis"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze Python â€” ${{ matrix.scan-type }}
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - scan-type: "Security"
            queries: security-extended
          - scan-type: "Quality"
            queries: security-and-quality

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Detect project structure
        id: detect
        run: |
          REQ=$(find . -name "requirements.txt" \
                  -not -path "*/venv/*" -not -path "*/.git/*" \
                  -not -path "*/dist/*" -not -path "*/build/*" \
                  | head -1)
          if [ -n "$REQ" ]; then
            echo "requirements=$REQ" >> $GITHUB_OUTPUT
            echo "found_req=true"    >> $GITHUB_OUTPUT
          else
            echo "found_req=false"   >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ "${{ steps.detect.outputs.found_req }}" = "true" ]; then
            pip install -r "${{ steps.detect.outputs.requirements }}" || true
          fi
          pip install bandit safety

      - name: Run Bandit security scan
        if: matrix.scan-type == 'Security'
        run: |
          bandit -r . \
            --exclude ./.git,./venv,./.venv,./dist,./build \
            --severity-level medium \
            --confidence-level medium \
            --format sarif \
            --output bandit-results.sarif || true

      - name: Run Safety dependency check
        if: matrix.scan-type == 'Security'
        run: |
          if [ "${{ steps.detect.outputs.found_req }}" = "true" ]; then
            safety check \
              --file "${{ steps.detect.outputs.requirements }}" \
              --output text || true
          fi

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
          build-mode: none
          queries: ${{ matrix.queries }}
          config: |
            paths-ignore:
              - "**/venv/**"
              - "**/.venv/**"
              - "**/dist/**"
              - "**/build/**"
              - "**/__pycache__/**"
              - "**/*.pyc"
            query-filters:
              - exclude:
                  tags contain: experimental

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python/scan:${{ matrix.scan-type }}"
          upload: always

      - name: Upload Bandit results to GitHub Security
        if: matrix.scan-type == 'Security' && hashFiles('bandit-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: bandit-results.sarif
          category: "bandit"

      - name: Generate scan summary
        if: always()
        run: |
          echo "## CodeQL Scan Summary â€” ${{ matrix.scan-type }}" >> $GITHUB_STEP_SUMMARY
          echo "| Campo    | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Tipo de scan | ${{ matrix.scan-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Queries  | ${{ matrix.queries }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rama     | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit   | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger  | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "Resultados en **Security â†’ Code scanning alerts**" >> $GITHUB_STEP_SUMMARY

  # â”€â”€ Reporte HTML consolidado descargable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-report:
    name: Security Report (HTML + CSV)
    runs-on: ubuntu-latest
    needs: analyze
    if: always()

    permissions:
      contents: read
      security-events: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install report dependencies
        run: pip install requests

      # Descarga todas las alertas via GitHub API y genera reporte HTML + CSV
      - name: Download alerts and generate report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO:     ${{ github.repository }}
          SHA:      ${{ github.sha }}
          RUN_ID:   ${{ github.run_id }}
          BRANCH:   ${{ github.ref_name }}
        run: |
          python3 << 'PYEOF'
          import os, json, csv, datetime, urllib.request, urllib.error

          token  = os.environ["GH_TOKEN"]
          repo   = os.environ["REPO"]
          sha    = os.environ["SHA"]
          run_id = os.environ["RUN_ID"]
          branch = os.environ["BRANCH"]
          now    = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")

          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json",
              "X-GitHub-Api-Version": "2022-11-28",
          }

          def gh_get(url):
              req = urllib.request.Request(url, headers=headers)
              try:
                  with urllib.request.urlopen(req) as r:
                      return json.loads(r.read())
              except urllib.error.HTTPError as e:
                  print(f"HTTP {e.code} en {url}")
                  return []

          # Paginar todas las alertas de code scanning
          alerts = []
          page = 1
          while True:
              url = f"https://api.github.com/repos/{repo}/code-scanning/alerts?per_page=100&page={page}&ref={branch}"
              batch = gh_get(url)
              if not batch:
                  break
              alerts.extend(batch)
              if len(batch) < 100:
                  break
              page += 1

          print(f"Total alertas descargadas: {len(alerts)}")

          # â”€â”€ Procesar alertas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          open_alerts   = [a for a in alerts if a.get("state") == "open"]
          closed_alerts = [a for a in alerts if a.get("state") == "dismissed" or a.get("state") == "fixed"]

          severity_order = {"critical":0,"high":1,"medium":2,"low":3,"warning":4,"note":5,"none":6}
          open_alerts.sort(key=lambda a: severity_order.get(
              a.get("rule",{}).get("severity","none"), 6))

          # Conteo por severidad
          sev_count = {}
          for a in open_alerts:
              s = a.get("rule",{}).get("severity","note")
              sev_count[s] = sev_count.get(s,0) + 1

          # Conteo por archivo
          file_count = {}
          for a in open_alerts:
              loc = a.get("most_recent_instance",{}).get("location",{})
              f = loc.get("path","desconocido")
              file_count[f] = file_count.get(f,0) + 1

          # â”€â”€ Generar CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          with open("security_report.csv","w",newline="",encoding="utf-8") as fcsv:
              w = csv.writer(fcsv)
              w.writerow(["#","Estado","Severidad","Regla","Descripcion","Archivo","Linea","Tool","URL"])
              for i, a in enumerate(alerts, 1):
                  loc  = a.get("most_recent_instance",{}).get("location",{})
                  rule = a.get("rule",{})
                  w.writerow([
                      i,
                      a.get("state",""),
                      rule.get("severity",""),
                      rule.get("id",""),
                      rule.get("description","")[:120],
                      loc.get("path",""),
                      loc.get("start_line",""),
                      a.get("tool",{}).get("name",""),
                      a.get("html_url",""),
                  ])

          # â”€â”€ Helpers HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          SEV_COLOR = {
              "critical":"#dc3545","high":"#fd7e14","medium":"#ffc107",
              "low":"#0dcaf0","warning":"#6f42c1","note":"#6c757d","none":"#adb5bd",
          }
          SEV_BADGE = {
              "critical":"danger","high":"warning","medium":"warning",
              "low":"info","warning":"secondary","note":"secondary","none":"light",
          }

          def badge(text, color="#6c757d"):
              return f'<span style="background:{color};color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600">{text.upper()}</span>'

          def sev_badge(s):
              return badge(s, SEV_COLOR.get(s,"#6c757d"))

          def state_badge(s):
              c = "#198754" if s=="open" else "#6c757d"
              return badge(s, c)

          # â”€â”€ Generar HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          sev_bars = ""
          total_open = len(open_alerts)
          for s in ["critical","high","medium","low","warning","note"]:
              cnt = sev_count.get(s,0)
              if cnt == 0:
                  continue
              pct = int(cnt/max(total_open,1)*100)
              sev_bars += f"""
                <div style="margin-bottom:8px">
                  <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                    <span>{sev_badge(s)}</span>
                    <span style="font-weight:700;color:{SEV_COLOR.get(s,'#333')}">{cnt}</span>
                  </div>
                  <div style="background:#2a2a3e;border-radius:4px;height:8px">
                    <div style="background:{SEV_COLOR.get(s,'#666')};width:{pct}%;height:8px;border-radius:4px"></div>
                  </div>
                </div>"""

          file_rows = ""
          for f,c in sorted(file_count.items(), key=lambda x:-x[1])[:10]:
              file_rows += f"<tr><td style='color:#90caf9;font-family:monospace;font-size:12px'>{f}</td><td style='text-align:center;font-weight:700'>{c}</td></tr>"

          alert_rows = ""
          for i, a in enumerate(open_alerts, 1):
              loc  = a.get("most_recent_instance",{}).get("location",{})
              rule = a.get("rule",{})
              sev  = rule.get("severity","note")
              path = loc.get("path","")
              line = loc.get("start_line","")
              url  = a.get("html_url","#")
              desc = rule.get("description","")[:100]
              tool = a.get("tool",{}).get("name","CodeQL")
              alert_rows += f"""
              <tr>
                <td style='color:#aaa;text-align:center'>{i}</td>
                <td>{sev_badge(sev)}</td>
                <td style='font-family:monospace;font-size:12px;color:#90caf9'>{rule.get("id","")}</td>
                <td style='font-size:12px'>{desc}</td>
                <td style='font-family:monospace;font-size:11px;color:#ce93d8'>{path}</td>
                <td style='text-align:center;color:#aaa'>{line}</td>
                <td style='font-size:11px;color:#aaa'>{tool}</td>
                <td style='text-align:center'><a href='{url}' target='_blank' style='color:#64b5f6;font-size:11px'>Ver</a></td>
              </tr>"""

          html = f"""<!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width,initial-scale=1">
            <title>Security Report â€” {repo}</title>
            <style>
              * {{ box-sizing:border-box;margin:0;padding:0 }}
              body {{ font-family:'Segoe UI',system-ui,sans-serif;background:#0d1117;color:#e6edf3;padding:24px }}
              h1 {{ font-size:22px;font-weight:700;margin-bottom:4px }}
              h2 {{ font-size:15px;font-weight:600;margin-bottom:12px;color:#8b949e;text-transform:uppercase;letter-spacing:.5px }}
              .meta {{ color:#8b949e;font-size:13px;margin-bottom:24px }}
              .meta b {{ color:#e6edf3 }}
              .grid {{ display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px }}
              .card {{ background:#161b22;border:1px solid #30363d;border-radius:10px;padding:20px }}
              .stat {{ font-size:36px;font-weight:700;margin-bottom:4px }}
              .stat.red {{ color:#f85149 }} .stat.green {{ color:#3fb950 }} .stat.gray {{ color:#8b949e }}
              table {{ width:100%;border-collapse:collapse;font-size:13px }}
              th {{ background:#161b22;color:#8b949e;padding:10px 12px;text-align:left;
                    border-bottom:1px solid #30363d;font-weight:600;font-size:11px;text-transform:uppercase }}
              td {{ padding:9px 12px;border-bottom:1px solid #21262d;vertical-align:middle }}
              tr:hover td {{ background:#161b22 }}
              .table-wrap {{ background:#0d1117;border:1px solid #30363d;border-radius:10px;overflow:hidden;margin-bottom:24px }}
              .footer {{ color:#8b949e;font-size:12px;text-align:center;margin-top:24px;padding-top:16px;border-top:1px solid #21262d }}
            </style>
          </head>
          <body>
            <h1>ğŸ” Security Scan Report</h1>
            <p class="meta">
              Repositorio: <b>{repo}</b> &nbsp;|&nbsp;
              Rama: <b>{branch}</b> &nbsp;|&nbsp;
              Commit: <b style="font-family:monospace">{sha[:8]}</b> &nbsp;|&nbsp;
              Generado: <b>{now}</b> &nbsp;|&nbsp;
              Run: <a href="https://github.com/{repo}/actions/runs/{run_id}" style="color:#58a6ff">#{run_id}</a>
            </p>

            <div class="grid">
              <div class="card">
                <div class="stat red">{len(open_alerts)}</div>
                <div>Alertas abiertas</div>
              </div>
              <div class="card">
                <div class="stat green">{len(closed_alerts)}</div>
                <div>Alertas cerradas / resueltas</div>
              </div>
              <div class="card">
                <div class="stat gray">{len(alerts)}</div>
                <div>Total historico</div>
              </div>
            </div>

            <div class="grid" style="grid-template-columns:1fr 1fr">
              <div class="card">
                <h2>Por Severidad</h2>
                {sev_bars}
              </div>
              <div class="card">
                <h2>Top archivos con alertas</h2>
                <table>
                  <thead><tr><th>Archivo</th><th>Alertas</th></tr></thead>
                  <tbody>{file_rows}</tbody>
                </table>
              </div>
            </div>

            <h2 style="margin-bottom:12px">Detalle de Alertas Abiertas ({len(open_alerts)})</h2>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>#</th><th>Severidad</th><th>Regla</th><th>Descripcion</th>
                    <th>Archivo</th><th>Linea</th><th>Tool</th><th>Link</th>
                  </tr>
                </thead>
                <tbody>{alert_rows}</tbody>
              </table>
            </div>

            <div class="footer">
              Generado automaticamente por GitHub Actions Â· VMware Inventory Security Pipeline
            </div>
          </body>
          </html>"""

          with open("security_report.html","w",encoding="utf-8") as f:
              f.write(html)

          print(f"Reporte HTML generado: security_report.html")
          print(f"Reporte CSV  generado: security_report.csv")
          PYEOF

      # Sube el reporte como artifact descargable en la pestaÃ±a Actions
      - name: Upload security report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.sha }}
          path: |
            security_report.html
            security_report.csv
          retention-days: 90

      - name: Final security summary
        if: always()
        run: |
          echo "## Reporte de Seguridad Generado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "El reporte detallado esta disponible como **artifact** descargable." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Como descargarlo:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Ir a Actions â†’ este workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Bajar hasta la seccion **Artifacts**" >> $GITHUB_STEP_SUMMARY
          echo "3. Descargar \`security-report-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Abrir \`security_report.html\` en el navegador" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Herramientas ejecutadas" >> $GITHUB_STEP_SUMMARY
          echo "| Herramienta     | Cobertura                         |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Security | Vulnerabilidades OWASP Top 10/CWE |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Quality  | Bugs, imports sin usar, code smells |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit          | Seguridad especifica de Python    |" >> $GITHUB_STEP_SUMMARY
          echo "| Safety          | CVEs en requirements.txt          |" >> $GITHUB_STEP_SUMMARY
